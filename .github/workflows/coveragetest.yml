name: go test coverage

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  coveragetest:
    runs-on: ubuntu-latest
    container: golang:1.24
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
      - name: generate test coverage
        run: go test ./... -coverprofile=./cover.out -covermode=atomic -coverpkg=./internal/...
      - name: Go test coverage check
        uses: vladopajic/go-test-coverage@v2
        continue-on-error: true
        with:
          config: ./.testcoverage.yml

      # Post coverage report as comment
      - name: Get PR number
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        id: get-pr
        with:
          script: |
            // –î–ª—è pull_request —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –Ω–æ–º–µ—Ä PR
            if (context.eventName === 'pull_request') {
              return context.payload.pull_request.number;
            }
            // –î–ª—è push —Å–æ–±—ã—Ç–∏—è –∏—â–µ–º PR –ø–æ –≤–µ—Ç–∫–µ
            else if (context.eventName === 'push') {
              const branch = context.ref.replace('refs/heads/', '');
              const pulls = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'open'
              });
              return pulls.data[0]?.number || null;
            }
            return null;
          result-encoding: string

      - name: post coverage report
        if: steps.get-pr.outputs.result != 'null' && steps.get-pr.outputs.result != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-tag: coverage-report
          pr-number: ${{ steps.get-pr.outputs.result }}
          message: |
            ## üìä Test Coverage Report
            
            **Coverage Summary:**
            ```
            ${{ steps.coverage.outputs.report }}
            ```
            
            _Generated by go-test-coverage action_

      - name: "finally check coverage"
        if: steps.coverage.outcome == 'failure'
        shell: bash
        run: echo "‚ùå Coverage check failed" && exit 1