name: go test coverage

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  coveragetest:
    runs-on: ubuntu-latest
    container: golang:1.24
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3

      - name: generate test coverage
        run: go test ./... -coverprofile=./cover.out -covermode=atomic -coverpkg=./internal/...
      - name: Go test coverage check
        id: coverage
        uses: vladopajic/go-test-coverage@v2
        continue-on-error: true
        with:
          config: ./.testcoverage.yml

      - name: post coverage report
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          comment-tag: coverage-report
          message: |
            ## ğŸ“Š Test Coverage Report
            
            **Coverage Summary:**
            ```
            ${{ steps.coverage.outputs.report }}
            ```
            
            _Generated by go-test-coverage action_

      - name: "finally check coverage"
        if: steps.coverage.outcome == 'failure'
        shell: bash
        run: echo "âŒ Coverage check failed" && exit 1